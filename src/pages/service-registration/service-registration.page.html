<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button
        defaultHref="/select-company"
        text=""
        icon="arrow-back-outline"
      ></ion-back-button>
    </ion-buttons>
    <ion-title>MANUT. SERVIÇOS</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="adicionarNovoServico()">
        <ion-icon name="add-circle-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>  
  <div *ngIf="isInitialLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Carregando serviços...</p>
  </div>
  
  <div *ngIf="noRecordsFound && !isInitialLoading" class="no-records-container">
    <ion-icon name="alert-circle-outline"></ion-icon>
    <p>Nenhum serviço cadastrado ainda.</p>
    <ion-button (click)="adicionarNovoServico()" fill="clear">
      Cadastrar primeiro serviço
    </ion-button>
  </div>

  <div *ngIf="!isInitialLoading && !noRecordsFound" class="main-content">
    <ion-list>
      <ion-item-sliding *ngIf="isNewService">
        <ion-item-options side="start">
          <ion-item-option color="danger" (click)="cancelar(0)">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-item-option>
        </ion-item-options>

        <ion-item
          class="service-item novo-item"
          detail="false"
          [class.expanded]="expandedIndex === 0"
        >
          <ion-thumbnail slot="start">
            <div class="no-image">
              <ion-icon name="image-outline"></ion-icon>
            </div>
          </ion-thumbnail>

          <ion-label class="service-info">
            <h2>Novo Serviço</h2>
            <p class="service-description">Preencha os dados abaixo</p>
          </ion-label>

          <div class="service-actions" (click)="$event.stopPropagation()">
            <ion-toggle
              [checked]="true"
              (ionChange)="serviceFormArray[0].patchValue({ active: $event.detail.checked })"
            ></ion-toggle>

            <div class="maintenance-icon" (click)="toggleExpand(0)">
              <ion-icon name="construct"></ion-icon>
              <span class="tooltip">Editar serviço</span>
            </div>
          </div>
        </ion-item>

        <ion-item *ngIf="expandedIndex === 0" class="expanded-content">
          <form [formGroup]="serviceFormArray[0]" class="service-form">
            <ion-grid>
              <ion-row>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label position="stacked">Nome</ion-label>
                    <ion-input formControlName="name" required></ion-input>
                  </ion-item>
                </ion-col>
                <ion-col size="12" size-md="6">
                  <ion-item class="category-select">
                    <ion-label position="stacked">Categoria</ion-label>
                    <ion-select
                      formControlName="category"
                      interface="action-sheet"
                      required
                      placeholder="Selecionar"
                    >
                      <ion-select-option
                        *ngFor="let category of categories"
                        [value]="category"
                      >
                        {{ category.name }}
                      </ion-select-option>
                    </ion-select>
                  </ion-item>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12">
                  <ion-item>
                    <ion-label position="stacked">Descrição</ion-label>
                    <ion-textarea
                      formControlName="description"
                      rows="3"
                    ></ion-textarea>
                  </ion-item>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label position="stacked">Preço</ion-label>
                    <ion-input
                      type="text"
                      aria-placeholder="Valor"
                      [value]="formattedPrices[0]"
                      (input)="onPriceInput($event, 0)"
                      required
                    ></ion-input>
                  </ion-item>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12">
                  <ion-item class="duration-item">
                    <ion-label position="floating">Duração</ion-label>
                    <div class="time-fields">
                      <ion-input
                        type="number"
                        formControlName="durationHours"
                        min="0"
                        max="23"
                        class="time-input"
                        placeholder="00"
                      ></ion-input>
                      <span class="time-separator">:</span>
                      <ion-input
                        type="number"
                        formControlName="durationMinutes"
                        min="0"
                        max="59"
                        class="time-input"
                        placeholder="00"
                      ></ion-input>
                    </div>
                  </ion-item>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label>Preço variável</ion-label>
                    <ion-toggle formControlName="variablePrice"></ion-toggle>
                  </ion-item>
                </ion-col>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label>Tempo variável</ion-label>
                    <ion-toggle formControlName="variableTime"></ion-toggle>
                  </ion-item>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12">
                  <div class="image-upload-container">
                    <div class="image-preview">
                      <img
                        *ngIf="previewUrls[0]"
                        [src]="previewUrls[0]"
                        alt="Preview da imagem do serviço"
                        class="service-image"
                      />
                      <div *ngIf="!previewUrls[0]" class="no-image">
                        <ion-icon name="image-outline"></ion-icon>
                        <p>Nenhuma imagem selecionada</p>
                      </div>
                    </div>
                    <div class="image-actions">
                      <input
                        type="file"
                        #fileInput
                        accept="image/*"
                        (change)="onImageSelected($event, 0)"
                        style="display: none"
                      />
                      <ion-button fill="clear" (click)="fileInput.click()">
                        <ion-icon name="camera" slot="start"></ion-icon>
                        Selecionar imagem
                      </ion-button>
                      <ion-button
                        *ngIf="previewUrls[0]"
                        fill="clear"
                        color="danger"
                        (click)="removeImage(0)"
                      >
                        <ion-icon name="trash" slot="start"></ion-icon>
                        Remover
                      </ion-button>
                    </div>
                  </div>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12">
                  <div class="form-actions">
                    <ion-button
                      expand="block"
                      color="primary"
                      (click)="salvar(0)"
                      [disabled]="serviceFormArray[0].invalid || isLoading[0]"
                    >
                      <ion-spinner
                        *ngIf="isLoading[0]"
                        name="crescent"
                      ></ion-spinner>
                      <span *ngIf="!isLoading[0]">SALVAR SERVIÇO</span>
                    </ion-button>

                    <ion-button
                      expand="block"
                      color="medium"
                      fill="outline"
                      (click)="cancelar(0)"
                    >
                      CANCELAR
                    </ion-button>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </form>
        </ion-item>
      </ion-item-sliding>

      <ion-item-sliding
        *ngFor="let service of services; let i = index; trackBy: trackByFn"
      >
        <ion-item-options side="start">
          <ion-item-option
            color="danger"
            (click)="cancelar(isNewService ? i+1 : i)"
          >
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-item-option>
        </ion-item-options>

        <ion-item
          (click)="toggleExpand(isNewService ? i+1 : i)"
          detail="false"
          class="service-item clickable-item"
          [class.expanded]="expandedIndex === (isNewService ? i+1 : i)"
        >
          <ion-thumbnail
            slot="start"
            *ngIf="previewUrls[isNewService ? i+1 : i]"
          >
            <img
              [src]="previewUrls[isNewService ? i+1 : i]"
              alt="Imagem do serviço"
            />
          </ion-thumbnail>

          <ion-label class="service-info">
            <h2>{{ service.name }}</h2>
            <p class="service-description">
              {{ service.description || 'Sem descrição' }}
            </p>
            <div class="service-meta">
              <span class="service-price"
                >{{ service.price | currency:'BRL' }}</span
              >
              <span class="service-duration">{{ service.duration }} min</span>
              <ion-badge *ngIf="service.variablePrice" color="warning"
                >Preço variável</ion-badge
              >
              <ion-badge *ngIf="service.variableTime" color="warning"
                >Tempo variável</ion-badge
              >
            </div>
          </ion-label>

          <div class="service-actions" (click)="$event.stopPropagation()">
            <ion-toggle
              [checked]="service.activated"
              (ionChange)="serviceFormArray[isNewService ? i+1 : i].patchValue({ active: $event.detail.checked })"
            ></ion-toggle>

            <div
              class="maintenance-icon"
              (click)="toggleExpand(isNewService ? i+1 : i)"
            >
              <ion-icon name="construct"></ion-icon>
              <span class="tooltip">Editar serviço</span>
            </div>
          </div>
        </ion-item>

        <ion-item-options side="end">
          <ion-item-option
            color="primary"
            (click)="salvar(isNewService ? i+1 : i)"
          >
            <div class="save-button-content">
              <ion-spinner
                *ngIf="isLoading[isNewService ? i+1 : i]"
                name="crescent"
                class="save-spinner"
              ></ion-spinner>
              <ion-icon
                *ngIf="!isLoading[isNewService ? i+1 : i] && !saved[isNewService ? i+1 : i]"
                name="save"
                slot="icon-only"
                class="save-icon"
              ></ion-icon>
              <div
                *ngIf="!isLoading[isNewService ? i+1 : i] && saved[isNewService ? i+1 : i]"
                class="saved-confirmation"
              >
                <ion-icon name="checkmark"></ion-icon>
              </div>
            </div>
          </ion-item-option>
        </ion-item-options>

        <ion-item
          *ngIf="expandedIndex === (isNewService ? i+1 : i)"
          class="expanded-content"
        >
          <form
            [formGroup]="serviceFormArray[isNewService ? i+1 : i]"
            class="service-form"
          >
            <ion-grid>
              <ion-row>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label position="floating">Nome</ion-label>
                    <ion-input formControlName="name" required></ion-input>
                  </ion-item>
                </ion-col>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label position="floating">Categoria</ion-label>
                    <ion-select
                      formControlName="category"
                      interface="action-sheet"
                      required
                    >
                      <ion-select-option
                        *ngFor="let category of categories"
                        [value]="category"
                      >
                        {{ category.name }}
                      </ion-select-option>
                    </ion-select>
                  </ion-item>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12">
                  <ion-item>
                    <ion-label position="floating">Descrição</ion-label>
                    <ion-textarea
                      formControlName="description"
                      rows="3"
                    ></ion-textarea>
                  </ion-item>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label position="stacked">Preço</ion-label>
                    <ion-input
                      type="text"
                      aria-placeholder="Valor"
                      [value]="formattedPrices[0]"
                      (input)="onPriceInput($event, 0)"
                      required
                    ></ion-input>
                  </ion-item>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12">
                  <ion-item class="duration-item">
                    <ion-label position="floating">Duração</ion-label>
                    <div class="time-fields">
                      <ion-input
                        type="number"
                        formControlName="durationHours"
                        min="0"
                        max="23"
                        class="time-input"
                        placeholder="00"
                      ></ion-input>
                      <span class="time-separator">:</span>
                      <ion-input
                        type="number"
                        formControlName="durationMinutes"
                        min="0"
                        max="59"
                        class="time-input"
                        placeholder="00"
                      ></ion-input>
                    </div>
                  </ion-item>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label>Preço variável</ion-label>
                    <ion-toggle formControlName="variablePrice"></ion-toggle>
                  </ion-item>
                </ion-col>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label>Tempo variável</ion-label>
                    <ion-toggle formControlName="variableTime"></ion-toggle>
                  </ion-item>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12">
                  <div class="image-upload-container">
                    <div class="image-preview">
                      <img
                        *ngIf="previewUrls[isNewService ? i+1 : i]"
                        [src]="previewUrls[isNewService ? i+1 : i]"
                        alt="Preview da imagem do serviço"
                        class="service-image"
                      />
                      <div
                        *ngIf="!previewUrls[isNewService ? i+1 : i]"
                        class="no-image"
                      >
                        <ion-icon name="image-outline"></ion-icon>
                        <p>Nenhuma imagem selecionada</p>
                      </div>
                    </div>
                    <div class="image-actions">
                      <input
                        type="file"
                        #fileInput
                        accept="image/*"
                        (change)="onImageSelected($event, isNewService ? i+1 : i)"
                        style="display: none"
                      />
                      <ion-button fill="clear" (click)="fileInput.click()">
                        <ion-icon name="camera" slot="start"></ion-icon>
                        Selecionar imagem
                      </ion-button>
                      <ion-button
                        *ngIf="previewUrls[isNewService ? i+1 : i]"
                        fill="clear"
                        color="danger"
                        (click)="removeImage(isNewService ? i+1 : i)"
                      >
                        <ion-icon name="trash" slot="start"></ion-icon>
                        Remover
                      </ion-button>
                    </div>
                  </div>
                </ion-col>
              </ion-row>

              <ion-row>
                <ion-col size="12">
                  <div class="form-actions">
                    <ion-button
                      expand="block"
                      color="primary"
                      (click)="salvar(isNewService ? i+1 : i)"
                      [disabled]="serviceFormArray[isNewService ? i+1 : i].invalid || isLoading[isNewService ? i+1 : i]"
                    >
                      <ion-spinner
                        *ngIf="isLoading[isNewService ? i+1 : i]"
                        name="crescent"
                      ></ion-spinner>
                      <span *ngIf="!isLoading[isNewService ? i+1 : i]"
                        >SALVAR ALTERAÇÕES</span
                      >
                    </ion-button>

                    <ion-button
                      expand="block"
                      color="medium"
                      fill="outline"
                      (click)="cancelar(isNewService ? i+1 : i)"
                    >
                      CANCELAR
                    </ion-button>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </form>
        </ion-item>
      </ion-item-sliding>
    </ion-list>
  </div>
</ion-content>
<app-footer-menu></app-footer-menu>
